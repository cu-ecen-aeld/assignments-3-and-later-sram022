#!/bin/sh
# Author: Sriram Rajkumar

DAEMON_NAME="aesdsocket"
BASEDIR="$(cd "$(dirname "$0")" && pwd)"
DAEMON="$BASEDIR/$DAEMON_NAME"
if [ ! -x "$DAEMON" ]; then
    echo "Warning: executable not found in default path: $DAEMON"
    DAEMON="/usr/bin/$DAEMON_NAME"

fi
DAEMON_OPTS="-d"
PIDFILE="/var/run/${DAEMON_NAME}.pid"

start() {
    echo "Starting $DAEMON_NAME..."

    if [ ! -x "$DAEMON" ]; then
        echo "ERROR: executable not found: $DAEMON"
        exit 1
    fi

    # Check if already running
    if pidof "$DAEMON_NAME" >/dev/null 2>&1; then
        echo "$DAEMON_NAME already running."
        exit 0
    fi

   
    start-stop-daemon --start --quiet --exec "$DAEMON" -- $DAEMON_OPTS
    sleep 0.5

    if pidof "$DAEMON_NAME" >/dev/null 2>&1; then
        echo "$DAEMON_NAME started."
    else
        echo "Failed to start $DAEMON $DAEMON_OPTS"
        exit 1
    fi
}

stop() {
    echo "Stopping $DAEMON_NAME..."

    # Send SIGTERM to all processes matching this executable path
    start-stop-daemon --stop --quiet --exec "$DAEMON" --signal TERM --retry 5

    # Verify Stop
    if pidof "$DAEMON_NAME" >/dev/null 2>&1; then
        echo "Process still running; sending SIGKILL..."
        start-stop-daemon --stop --quiet --exec "$DAEMON" --signal KILL --retry 3
    fi

    if ! pidof "$DAEMON_NAME" >/dev/null 2>&1; then
        echo "$DAEMON_NAME stopped."
    else
        echo "Failed to stop $DAEMON_NAME."
        exit 1
    fi
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    stop
    sleep 1
    start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac

exit 0